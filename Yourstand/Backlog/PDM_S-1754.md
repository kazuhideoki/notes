# YS4B 利用履歴のあるドメインを削除する場合「利用履歴があるため削除できない」旨のエラーメッセージを表示する

## Links

- [[2025-04-01]]

## Backlog Link

https://yourstand.backlog.com/view/PDM_S-1754

## 課題内容

```
ドメインの削除に当たって利用履歴があるドメインを削除できないように対応しているが、そのエラーメッセージが特に出ないため、「利用履歴があるため削除できない」旨のエラーメッセージを表示するように対応する。
```

## メモ

PrismaService に Nestjs のエラー内容をデフォルトで投げるように拡張している。
これは妥当か？

メリット
- アプリケーション層でハンドリングしなくてよくなる。共通のエラーに対してフロントエンドまで伝播するエラーメッセージを投げることを定義できるので軽量な変更

デメリット
- 責務の分離が曖昧になる
	- Nestjs の組み込みのエラーに変換するということは、APIサーバーとして何を返すか？というビジネスロジックを持つということになる。(例「ここではこのエラーはありえない -> 500系」「ここでは誤ったリクエスト方法を行った場合にFK制約エラーになるから400系」)
- PrismaService は OCPP Server を構築するときでも利用される。OCPP Server は WebSocket Server。そういう意味でも責務が曖昧になっていないだろうか？(既存)

代案
1. 呼び出し元で処理。もっともビジネスロジックの文脈を知っているのは呼び出し元。ここでやるのが確実。起こりうる `PrismaClientKnownRequestError` をつぶせていないという意味で実装が足りてないので直したほうがいいとも考えられる
2. `CustomExceptionFilter` で処理する。これは未処理の例外も含め HTTPレスポンスに変換する責務を持っている。そういう意味では PrismaSerivce よりこちらが妥当そうな気がする。APIサーバーにのみ適用されるので